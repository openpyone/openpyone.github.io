<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MangoPy | 碼寶程式教育</title>
<link rel="icon" href="/favicon.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<style>
html, body {margin:0; height:100%; font-size:24px; overflow:hidden;}
body {font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:white; color:#000;}
.app {display:grid; grid-template-columns:1fr 8px 1fr; height:100vh; gap:0; padding:0;}
.card {background:#ffffff; border-radius:0; display:flex; flex-direction:column; overflow:hidden; padding:0px; height:100%;}
.editor-panel {padding:0; height:100%;}
.editor-top {display:flex; align-items:center; gap:8px; margin-bottom:6px;}
.controls {margin-left:auto; display:flex; gap:8px;}
button {border:none; padding:6px 12px; cursor:pointer; font-size:inherit;}
.btn {background:#ddd;color:#000;border-radius:0;}
.btn:hover {background:#ccc;}
.btn.primary {background:#11a211;color:white;font-weight:400;border-radius:5px;margin-top:6px;}
.btn.save {background:#0000cd;color:white;font-weight:400;border-radius:5px;margin-top:6px;margin-right:6px;}
#editor { width:100%; font-size:24px; height:100%; }
#terminal { flex:1; background:#1e1e1e; color:#fff; font-family:monospace; font-size:24px; overflow:auto; padding:12px;}
.cell {display:flex; padding:1px 4px; margin-bottom:2px; border-radius:0px; word-wrap: break-word;}
.cell-number { width:50px; background:#000; color:#fff; text-align:right; margin-right:8px; border-radius:3px; padding-right:4px; }
.output-cell { background:#002200; color:#a6f2a6; flex:1; }
.error-cell { background:#330000; color:#ff7b7b; flex:1; }
.dragbar { cursor: col-resize; background: #f87f2a; width: 4px; height: 100%; }
small {font-size: 0.8em;}
.footer-line {margin:2px 6px;border-top:solid 2px green;}
</style>
</head>
<body>

<div class="app" id="app">
  <div class="card editor-panel" id="leftPanel">
    <div class="editor-top">
      <div>&nbsp;🥭MangoPy | Code(程式)</div>
      <div class="controls">
        <button id="runBtn" class="btn primary" title="執行">Run ▶</button>
        <button id="saveBtn" class="btn save" title="存檔">Save</button>
      </div>
    </div>
    <textarea id="editor"></textarea>
    <p class="footer-line"><strong>&copy; 碼寶程式教育 </strong><small>兒童青少年程語教學 + APCS檢定培訓</small></p>
  </div>

  <div class="dragbar" id="dragbar"></div>

  <div class="card" id="rightPanel">
    <div id="terminal"></div>
  </div>
</div>

<!-- CodeMirror JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/comment/comment.min.js"></script>

<!-- Brython -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.3/brython.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.11.3/brython_stdlib.js"></script>

<script>
var editor;
window.addEventListener('load', function(){
    editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        mode:"python",
        theme:"default",
        lineNumbers:true,
        matchBrackets:true,
        autoCloseBrackets:true,
        tabSize:4,
        indentUnit:4,
        indentWithTabs:false,
        viewportMargin: Infinity,
        lineWrapping:true,
        extraKeys: {
            "Ctrl-/": "toggleComment",
            "Cmd-/": "toggleComment",
            "Tab": function(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection("add");
                } else {
                    cm.replaceSelection("    ", "end"); // 或用 cm.execCommand("insertSoftTab");
                }
            },
            "Shift-Tab": function(cm) {
                cm.indentSelection("subtract");
            }
        }
    });
    editor.setSize(null, window.innerHeight);
    editor.setValue(`# 碼寶程式教育
print("Hello World ❤️")
for i in range(1, 100+1):
    if i % 2 == 0:
        print(i, "even")
    elif i % 2 == 1:
        print(i, "odd")`);
    brython();
});

// 調整 Editor 與右側高度
function adjustHeight() {
    var vh = window.innerHeight;
    editor.setSize(null, vh);
}
window.addEventListener('resize', adjustHeight);

// 左右拖拉
const dragbar = document.getElementById('dragbar');
let dragging = false;
dragbar.addEventListener('mousedown', function(e){ dragging = true; document.body.style.cursor = 'col-resize'; e.preventDefault(); });
window.addEventListener('mousemove', function(e){
  if (!dragging) return;
  let minLeft = 450, maxLeft = window.innerWidth - 450 - dragbar.offsetWidth;
  let leftWidth = e.clientX; if(leftWidth<minLeft) leftWidth=minLeft; if(leftWidth>maxLeft) leftWidth=maxLeft;
  document.getElementById('app').style.gridTemplateColumns = `${leftWidth}px 8px 1fr`;
  editor.setSize(null, document.getElementById('leftPanel').clientHeight - document.querySelector('.editor-top').offsetHeight);
});
window.addEventListener('mouseup', function(e){ dragging = false; document.body.style.cursor='default'; });

// Save
document.getElementById('saveBtn').addEventListener('click',function(){
    const code=editor.getValue();
    const now=new Date();
    const pad=n=>n.toString().padStart(2,'0');
    const filename=now.getFullYear()+pad(now.getMonth()+1)+pad(now.getDate())+
                   pad(now.getHours())+pad(now.getMinutes())+pad(now.getSeconds())+".py";
    const blob=new Blob([code],{type:"text/plain;charset=utf-8"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
});

// Run
document.getElementById('runBtn').addEventListener('click', function(){
    const code = editor.getValue();
    terminal = document.getElementById("terminal");
    terminal.textContent="";
    window.run_code(code);
});
</script>

<script type="text/python">
from browser import document, window
import sys
import html

terminal = document["terminal"]
cell_counter = 0

class TerminalWriter:
    def __init__(self, color="output"):
        self.color=color
        self.buffer=""
    def write(self, data):
        global cell_counter
        if not data: return
        self.buffer += str(data)
        while "\n" in self.buffer:
            line, self.buffer = self.buffer.split("\n", 1)
            cell_counter += 1
            div = document.createElement("div")
            div.className = "cell " + ("output-cell" if self.color=="output" else "error-cell")
            number_div = document.createElement("div")
            number_div.className = "cell-number"
            number_div.textContent = str(cell_counter)
            div <= number_div
            # 支援 HTML entities
            div.innerHTML += html.escape(line)
            terminal <= div
            terminal.scrollTop = terminal.scrollHeight
    def flush(self):
        global cell_counter
        if self.buffer:
            cell_counter += 1
            div = document.createElement("div")
            div.className = "cell " + ("output-cell" if self.color=="output" else "error-cell")
            number_div = document.createElement("div")
            number_div.className = "cell-number"
            number_div.textContent = str(cell_counter)
            div <= number_div
            div.innerHTML += html.escape(self.buffer)
            terminal <= div
            terminal.scrollTop = terminal.scrollHeight
            self.buffer=""

sys.stdout = TerminalWriter("output")
sys.stderr = TerminalWriter("error")

def run_code(code):
    global cell_counter
    cell_counter = 0
    import builtins
    builtins.input = input
    try:
        exec(code, {})
    except Exception as e:
        writer = TerminalWriter("error")
        writer.write("Error: "+str(e))
        writer.flush()

window.run_code = run_code
</script>
</body>
</html>
